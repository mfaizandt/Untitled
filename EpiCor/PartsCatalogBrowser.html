<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Parts Catalog Browser</title>
    
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    
    <!-- jsTree CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.12/themes/default/style.min.css" />
    
    <!-- jsTree JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.12/jstree.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 300;
            letter-spacing: 1px;
        }
        
        .header p {
            font-size: 1em;
            opacity: 0.9;
        }
        
        .controls {
            padding: 20px 30px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }
        
        .controls-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .controls-group label {
            font-weight: 600;
            color: #333;
            min-width: 100px;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }
        
        #search {
            flex: 1;
            min-width: 250px;
            padding: 12px 15px;
            font-size: 15px;
            border: 2px solid #e9ecef;
            border-radius: 5px;
            transition: border-color 0.3s;
        }
        
        #search:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .content {
            padding: 30px;
        }
        
        #tree {
            border: 1px solid #e9ecef;
            border-radius: 5px;
            padding: 15px;
            background: white;
        }
        
        /* jsTree customization */
        #tree .jstree-node {
            min-height: 32px;
            will-change: transform;
        }
        
        #tree .jstree-anchor {
            padding: 5px 4px;
            height: 30px;
            line-height: 30px;
            border-radius: 3px;
            transition: background-color 0.15s ease;
            will-change: background-color;
        }
        
        #tree .jstree-anchor:hover {
            background: rgba(102, 126, 234, 0.1);
        }
        
        #tree .jstree-anchor.jstree-hovered {
            background: rgba(102, 126, 234, 0.15);
        }
        
        #tree .jstree-anchor.jstree-clicked {
            background: rgba(102, 126, 234, 0.25);
            color: #667eea;
        }
        
        #tree .jstree-icon {
            margin-right: 8px;
        }
        
        /* GPU acceleration for tree children */
        #tree .jstree-children {
            transform: translate3d(0, 0, 0);
            backface-visibility: hidden;
            perspective: 1000px;
        }
        
        .tree-category {
            font-weight: 700;
            color: #667eea;
        }
        
        .tree-group {
            font-weight: 600;
            color: #764ba2;
        }
        
        .tree-item {
            color: #555;
            font-size: 13px;
        }
        
        .status-message {
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 5px;
            background: #fff3cd;
            border: 1px solid #ffc107;
            color: #856404;
            display: none;
        }
        
        .status-message.show {
            display: block;
        }
        
        .file-upload {
            margin-top: 15px;
            padding: 15px;
            background: #e8f5e9;
            border: 2px dashed #4CAF50;
            border-radius: 5px;
            text-align: center;
        }
        
        .file-upload input {
            padding: 10px;
            font-size: 14px;
        }
        
        .upload-loader {
            display: none;
            margin-top: 15px;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 5px;
            color: white;
            text-align: center;
        }
        
        .upload-loader.show {
            display: block;
        }
        
        .loader-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }
        
        .upload-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        .upload-info {
            font-size: 14px;
            line-height: 1.6;
        }
        
        .upload-duration {
            font-size: 12px;
            opacity: 0.9;
            font-weight: 600;
        }
        
        .upload-success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            animation: slideIn 0.3s ease;
        }
        
        .upload-error {
            background: linear-gradient(135deg, #f44336 0%, #e53935 100%);
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .search-loading {
            display: inline-block;
            margin-left: 10px;
            font-size: 12px;
            color: #667eea;
            font-weight: 600;
        }
        
        .spinner {
            display: inline-block;
            width: 14px;
            height: 14px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 5px;
            vertical-align: middle;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Form Styles */
        .auth-form {
            padding: 20px;
            background: white;
            border-radius: 5px;
            margin-bottom: 20px;
            border: 1px solid #e9ecef;
        }
        
        .auth-form h2 {
            margin-bottom: 20px;
            color: #667eea;
            font-size: 1.5em;
            font-weight: 600;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
        }
        
        .form-group input {
            width: 100%;
            padding: 12px 15px;
            font-size: 15px;
            border: 2px solid #e9ecef;
            border-radius: 5px;
            transition: border-color 0.3s;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .form-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .form-actions .btn {
            flex: 1;
        }
        
        .hidden {
            display: none !important;
        }
        
        /* Manufacturer Selection Styles */
        .selection-summary-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 15px 0;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
        }
        
        .manufacturer-tree-item {
            margin-bottom: 10px;
            border: 1px solid #e9ecef;
            border-radius: 5px;
            overflow: hidden;
        }
        
        .manufacturer-header {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            background: #f8f9fa;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .manufacturer-header:hover {
            background: #e9ecef;
        }
        
        .tree-toggle {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0 10px 0 0;
            font-size: 12px;
            color: #667eea;
        }
        
        .tree-icon {
            display: inline-block;
            width: 12px;
        }
        
        .manufacturer-checkbox-label {
            display: flex;
            align-items: center;
            flex: 1;
            cursor: pointer;
            margin: 0;
        }
        
        .manufacturer-checkbox {
            margin-right: 10px;
            cursor: pointer;
        }
        
        .manufacturer-name {
            font-weight: 600;
            color: #333;
        }
        
        .brand-count {
            font-size: 12px;
            color: #6c757d;
            margin-left: auto;
        }
        
        .brands-container {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }
        
        .brands-container.expanded {
            max-height: 1000px;
        }
        
        .brands-list {
            padding: 10px 15px 10px 40px;
            background: white;
        }
        
        .brand-item {
            display: flex;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .brand-item:last-child {
            border-bottom: none;
        }
        
        .brand-checkbox {
            margin-right: 10px;
            cursor: pointer;
        }
        
        .brand-name {
            color: #555;
            font-size: 14px;
        }
        
        /* Parts Display Styles */
        .parts-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        .parts-table th,
        .parts-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }
        
        .parts-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #667eea;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .parts-table tr:hover {
            background: #f8f9fa;
        }
        
        .part-image {
            max-width: 100px;
            max-height: 100px;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .part-image:hover {
            transform: scale(1.1);
            transition: transform 0.2s;
        }
        
        .part-number {
            font-weight: 600;
            color: #667eea;
        }
        
        .part-manufacturer {
            color: #764ba2;
            font-weight: 500;
        }
        
        /* Navigation Styles */
        .breadcrumb {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 5px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .breadcrumb-item {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #6c757d;
            font-size: 14px;
        }
        
        .breadcrumb-item.active {
            color: #667eea;
            font-weight: 600;
        }
        
        .breadcrumb-separator {
            color: #adb5bd;
        }
        
        .breadcrumb-link {
            color: #667eea;
            cursor: pointer;
            text-decoration: none;
            transition: color 0.2s;
        }
        
        .breadcrumb-link:hover {
            color: #764ba2;
            text-decoration: underline;
        }
        
        .nav-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e9ecef;
        }
        
        .nav-title {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .nav-title h2 {
            margin: 0;
        }
        
        .nav-title .subtitle {
            font-size: 14px;
            color: #6c757d;
            font-weight: normal;
        }
        
        /* Progress Summary Styles */
        .progress-summary {
            position: sticky;
            top: 0;
            z-index: 1000;
            background: white;
            border-bottom: 2px solid #e9ecef;
            padding: 15px 30px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            max-height: 300px;
            overflow-y: auto;
        }
        
        .progress-summary.hidden {
            display: none;
        }
        
        .progress-summary-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e9ecef;
        }
        
        .progress-summary-header h3 {
            margin: 0;
            color: #667eea;
            font-size: 1.2em;
        }
        
        .progress-sections {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .progress-section {
            flex: 1;
            min-width: 250px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 5px;
            border-left: 3px solid #667eea;
        }
        
        .progress-section-title {
            font-weight: 600;
            color: #667eea;
            margin-bottom: 8px;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .progress-item {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
            font-size: 13px;
        }
        
        .progress-label {
            font-weight: 600;
            color: #6c757d;
            margin-right: 10px;
        }
        
        .progress-value {
            color: #333;
            text-align: right;
            flex: 1;
        }
        
        .download-btn {
            padding: 4px 10px;
            font-size: 11px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            margin-top: 8px;
            transition: background 0.2s;
        }
        
        .download-btn:hover {
            background: #218838;
        }
        
        .download-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        
        @media (max-width: 768px) {
            .progress-sections {
                flex-direction: column;
            }
            
            .progress-summary {
                padding: 10px 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöó Vehicle Parts Catalog</h1>
            <p>Browse and search through our comprehensive parts database</p>
        </div>
        
        <!-- Progress Summary Section -->
        <div id="progressSummary" class="progress-summary hidden">
            <div class="progress-summary-header">
                <h3>üìä Progress Summary</h3>
            </div>
            <div class="progress-sections">
                <!-- Vehicle Information Section -->
                <div id="vehicleInfoSection" class="progress-section hidden">
                    <div class="progress-section-title">üöó Vehicle Information</div>
                    <div id="vehicleInfoContent"></div>
                    <button class="download-btn" id="downloadVinBtn" onclick="downloadVinResponse()">üì• Download VIN Response</button>
                </div>
                
                <!-- Catalog Selection Section -->
                <div id="catalogSelectionSection" class="progress-section hidden">
                    <div class="progress-section-title">üìã Catalog Selection</div>
                    <div id="catalogSelectionContent"></div>
                    <button class="download-btn" id="downloadCategoryTreeBtn" onclick="downloadCategoryTree()">üì• Download Category Tree</button>
                </div>
                
                <!-- Manufacturer Selection Section -->
                <div id="manufacturerSelectionSection" class="progress-section hidden">
                    <div class="progress-section-title">üè≠ Manufacturer Selection</div>
                    <div id="manufacturerSelectionContent"></div>
                    <button class="download-btn" id="downloadManufacturersBtn" onclick="downloadManufacturers()">üì• Download Manufacturers</button>
                </div>
                
                <!-- Parts Section -->
                <div id="partsSection" class="progress-section hidden">
                    <div class="progress-section-title">üîß Parts</div>
                    <div id="partsContent"></div>
                    <button class="download-btn" id="downloadPartsBtn" onclick="downloadParts()">üì• Download Parts</button>
                </div>
            </div>
        </div>
        
        <div class="controls">
            <div class="controls-group">
                <label>Quick Actions:</label>
                <button class="btn btn-primary" id="expandAllBtn">Expand All</button>
                <button class="btn btn-secondary" id="collapseAllBtn">Collapse All</button>
            </div>
            
            <div class="controls-group">
                <input type="text" id="search" placeholder="üîç Search categories, groups, or parts...">
                <span id="searchLoading" class="search-loading" style="display: none;">
                    <span class="spinner"></span>Searching...
                </span>
            </div>
        </div>
        
        <div class="content">
            <div id="statusMessage" class="status-message"></div>
            
            <!-- Login Form -->
            <div id="loginForm" class="auth-form">
                <h2>üîê Login Required</h2>
                <div class="form-group">
                    <label for="username">Username:</label>
                    <input type="text" id="username" placeholder="Enter your username" />
                </div>
                <div class="form-group">
                    <label for="password">Password:</label>
                    <input type="password" id="password" placeholder="Enter your password" />
                </div>
                <div class="form-actions">
                    <button class="btn btn-primary" id="loginBtn">Login</button>
                </div>
            </div>
            
            <!-- VIN Input Form -->
            <div id="vinForm" class="auth-form hidden">
                <h2>üöó Enter Vehicle VIN</h2>
                <div class="form-group">
                    <label for="vin">VIN:</label>
                    <input type="text" id="vin" placeholder="Enter 17-character VIN" maxlength="17" />
                </div>
                <div class="form-actions">
                    <button class="btn btn-primary" id="decodeVinBtn">Decode VIN</button>
                </div>
            </div>
            
            <!-- Manufacturer Selection Form -->
            <div id="manufacturerSelection" class="auth-form hidden">
                <div class="breadcrumb" id="manufacturerBreadcrumb">
                    <span class="breadcrumb-item">
                        <a href="#" class="breadcrumb-link" id="breadcrumbVinFromManufacturers">VIN</a>
                    </span>
                    <span class="breadcrumb-separator">‚Ä∫</span>
                    <span class="breadcrumb-item">
                        <a href="#" class="breadcrumb-link" id="breadcrumbTree">Catalog Tree</a>
                    </span>
                    <span class="breadcrumb-separator">‚Ä∫</span>
                    <span class="breadcrumb-item active">
                        <span id="breadcrumbCatalogName">Select Manufacturers</span>
                    </span>
                </div>
                <div class="nav-header">
                    <div class="nav-title">
                        <h2>üè≠ Select Manufacturers</h2>
                        <span class="subtitle" id="manufacturerSubtitle">Select manufacturers and brands for the catalog object</span>
                    </div>
                    <button class="btn btn-secondary" id="backToTreeBtn">‚Üê Back to Catalog</button>
                </div>
                <div id="manufacturerLoading" class="upload-loader" style="display: none;">
                    <div class="loader-content">
                        <div class="upload-spinner"></div>
                        <div class="upload-info">Loading manufacturers...</div>
                    </div>
                </div>
                <div id="manufacturerContent" style="display: none;">
                    <div class="form-group">
                        <label for="manufacturerSearch">Search Manufacturers or Brands:</label>
                        <input type="text" id="manufacturerSearch" placeholder="Type to search..." />
                    </div>
                    <div class="selection-summary-bar" style="display: flex; justify-content: space-between; align-items: center; margin: 15px 0; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                        <span id="selectedCount">0 brands selected</span>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-secondary" id="selectAllBtn">Select All</button>
                            <button class="btn btn-secondary" id="deselectAllBtn">Deselect All</button>
                        </div>
                    </div>
                    <div id="manufacturerList" style="max-height: 500px; overflow-y: auto; border: 1px solid #e9ecef; border-radius: 5px; padding: 15px;"></div>
                    <div class="form-actions" style="margin-top: 20px;">
                        <button class="btn btn-primary" id="viewPartsBtn">View Parts ‚Üí</button>
                    </div>
                </div>
            </div>
            
            <!-- Parts Display Area -->
            <div id="partsView" class="auth-form hidden">
                <div class="breadcrumb" id="partsBreadcrumb">
                    <span class="breadcrumb-item">
                        <a href="#" class="breadcrumb-link" id="breadcrumbVinFromParts">VIN</a>
                    </span>
                    <span class="breadcrumb-separator">‚Ä∫</span>
                    <span class="breadcrumb-item">
                        <a href="#" class="breadcrumb-link" id="breadcrumbTreeFromParts">Catalog Tree</a>
                    </span>
                    <span class="breadcrumb-separator">‚Ä∫</span>
                    <span class="breadcrumb-item">
                        <a href="#" class="breadcrumb-link" id="breadcrumbManufacturers">Manufacturers</a>
                    </span>
                    <span class="breadcrumb-separator">‚Ä∫</span>
                    <span class="breadcrumb-item active">
                        <span id="breadcrumbPartsName">Parts List</span>
                    </span>
                </div>
                <div class="nav-header">
                    <div class="nav-title">
                        <h2>üîß Parts List</h2>
                        <span class="subtitle" id="partsSubtitle">Parts for selected manufacturers</span>
                    </div>
                    <button class="btn btn-secondary" id="backToManufacturersBtn">‚Üê Back to Manufacturers</button>
                </div>
                <div id="partsLoading" class="upload-loader" style="display: none;">
                    <div class="loader-content">
                        <div class="upload-spinner"></div>
                        <div class="upload-info">Loading parts...</div>
                    </div>
                </div>
                <div id="partsContent">
                    <div id="partsList" style="max-height: 600px; overflow-y: auto;"></div>
                </div>
            </div>
            
            <!-- Catalog Tree View -->
            <div id="treeView" class="hidden">
                <div class="breadcrumb" id="treeBreadcrumb">
                    <span class="breadcrumb-item">
                        <a href="#" class="breadcrumb-link" id="breadcrumbVin">VIN</a>
                    </span>
                    <span class="breadcrumb-separator">‚Ä∫</span>
                    <span class="breadcrumb-item active">
                        <span>Catalog Tree</span>
                    </span>
                </div>
                <div class="nav-header">
                    <div class="nav-title">
                        <h2>üìã Parts Catalog</h2>
                        <span class="subtitle">Select one or more catalog objects, then click Next</span>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-primary" id="nextToManufacturersBtn" style="display: none;">Next ‚Üí</button>
                        <button class="btn btn-secondary" id="backToVinBtn">‚Üê Back to VIN</button>
                    </div>
                </div>
                <div id="catalogSelectionInfo" style="padding: 10px; margin-bottom: 15px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 5px; display: block;">
                    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                        <span id="selectedCatalogCount" style="font-weight: 600; color: #856404;">0 catalog objects selected</span>
                        <span style="font-size: 12px; color: #856404;">üí° <strong>Tip:</strong> Hold <kbd style="background: #fff; padding: 2px 6px; border: 1px solid #ccc; border-radius: 3px; font-size: 11px;">Ctrl</kbd> (Windows/Linux) or <kbd style="background: #fff; padding: 2px 6px; border: 1px solid #ccc; border-radius: 3px; font-size: 11px;">Cmd</kbd> (Mac) and click to select multiple items</span>
                    </div>
                </div>
            </div>
            
            <div id="tree"></div>
        </div>
    </div>

    <script>
        // API Configuration
        const API_BASE_URL = 'https://pilot.epicor-auto-catalog.cloud';
        let accessToken = null;
        let vehicleConfig = null;
        
        // Application state
        let catalogData;
        let treeInstance;
        let searchTimeout;
        let isSearching = false;
        let searchActive = false;
        
        // Manufacturer and Parts state
        let selectedCatalogObjectID = null; // Keep for backward compatibility
        let selectedCatalogObjects = []; // Array of {catalogObjectID, catalogObjectName, category, group}
        let selectedGroups = []; // Array of {groupID, groupName, categoryID, categoryName}
        let manufacturers = [];
        let allBrands = [];
        let selectedBrands = new Set();
        let parts = [];
        
        // Progress summary state
        let vinDecodeResponse = null;
        let selectedCategory = null;
        let selectedGroup = null;
        let autoAdvanceToPartsScreen = false; // Flag to auto-advance from manufacturers to parts
        let selectedCatalogObjectName = null;
        let apiResponses = {
            vinDecode: null,
            categoryTree: null,
            manufacturers: null,
            parts: null
        };
        
        // Initialize when document is ready
        $(document).ready(function() {
            setupEventHandlers();
            showLoginForm();
        });
        
        function setupEventHandlers() {
            // Login button
            $('#loginBtn').click(function() {
                const username = $('#username').val().trim();
                const password = $('#password').val().trim();
                
                if (!username || !password) {
                    showStatus('‚ö†Ô∏è Please fill in all fields', 'warning');
                    return;
                }
                
                loginUser(username, password);
            });
            
            // Login form - allow Enter key to submit
            $('#username, #password').on('keypress', function(e) {
                if (e.which === 13) {
                    $('#loginBtn').click();
                }
            });
            
            // Decode VIN button
            $('#decodeVinBtn').click(function() {
                const vin = $('#vin').val().trim();
                
                if (!vin) {
                    showStatus('‚ö†Ô∏è Please enter a VIN', 'warning');
                    return;
                }
                
                if (vin.length !== 17) {
                    showStatus('‚ö†Ô∏è VIN must be exactly 17 characters', 'warning');
                    return;
                }
                
                decodeVin(vin);
            });
            
            // VIN form - allow Enter key to submit
            $('#vin').on('keypress', function(e) {
                if (e.which === 13) {
                    $('#decodeVinBtn').click();
                }
            });
            
            // Back to VIN button
            $('#backToVinBtn').click(function() {
                showVinForm();
            });
            
            // Next to Manufacturers button
            $('#nextToManufacturersBtn').click(function() {
                if (selectedCatalogObjects.length === 0 && selectedGroups.length === 0) {
                    showStatus('‚ö†Ô∏è Please select at least one catalog object or group', 'warning');
                    return;
                }
                // Set flag to auto-advance to parts screen after manufacturers load
                autoAdvanceToPartsScreen = true;
                // Build array of both catalog object IDs and group IDs
                const catalogObjectIDs = selectedCatalogObjects.map(obj => obj.catalogObjectID);
                const catalogGroupIDs = selectedGroups.map(grp => grp.groupID);
                fetchManufacturers(catalogObjectIDs, catalogGroupIDs);
            });
            
            // Manufacturer selection buttons
            $('#backToTreeBtn').click(function(e) {
                e.preventDefault();
                console.log('Back to Catalog clicked');
                showTreeView();
            });
            
            $('#breadcrumbTree').click(function(e) {
                e.preventDefault();
                showTreeView();
            });
            
            $('#breadcrumbVinFromManufacturers').click(function(e) {
                e.preventDefault();
                showVinForm();
            });
            
            $('#selectAllBtn').click(function() {
                selectAllBrands();
            });
            
            $('#deselectAllBtn').click(function() {
                deselectAllBrands();
            });
            
            $('#viewPartsBtn').click(function() {
                if (selectedBrands.size === 0) {
                    showStatus('‚ö†Ô∏è Please select at least one brand', 'warning');
                    return;
                }
                fetchParts();
            });
            
            // Parts view buttons
            $('#backToManufacturersBtn').click(function() {
                showManufacturerSelection();
            });
            
            $('#breadcrumbVinFromParts').click(function(e) {
                e.preventDefault();
                showVinForm();
            });
            
            $('#breadcrumbTreeFromParts').click(function(e) {
                e.preventDefault();
                showTreeView();
            });
            
            $('#breadcrumbManufacturers').click(function(e) {
                e.preventDefault();
                showManufacturerSelection();
            });
            
            $('#breadcrumbVin').click(function(e) {
                e.preventDefault();
                showVinForm();
            });
            
            // Manufacturer search
            $('#manufacturerSearch').on('input', function() {
                filterManufacturers($(this).val().toLowerCase().trim());
            });
            
            // Expand All button
            $('#expandAllBtn').click(function() {
                if (treeInstance) {
                    treeInstance.open_all();
                }
            });
            
            // Collapse All button
            $('#collapseAllBtn').click(function() {
                if (treeInstance) {
                    treeInstance.close_all();
                }
            });
            
            // Search functionality with debouncing
            $('#search').on('keyup', function() {
                const searchTerm = $(this).val().toLowerCase().trim();
                
                // Clear previous timeout
                clearTimeout(searchTimeout);
                
                // If search term is empty, clear search
                if (!searchTerm) {
                    if (treeInstance) {
                        treeInstance.clear_search();
                        searchActive = false;
                        // Re-enable animations after search clears
                        $('#tree').jstree('set_animation', 200);
                    }
                    $('#searchLoading').hide();
                    isSearching = false;
                    return;
                }
                
                // Show loading indicator
                $('#searchLoading').show();
                isSearching = true;
                searchActive = true;
                // Disable animations while searching
                if (treeInstance) {
                    $('#tree').jstree('set_animation', 0);
                }
                
                // Debounce the search - wait 500ms after user stops typing
                searchTimeout = setTimeout(function() {
                    if (treeInstance) {
                        // Use optimized search with minimal re-rendering
                        performOptimizedSearch(searchTerm);
                    }
                    $('#searchLoading').hide();
                    isSearching = false;
                }, 500);
            });
        }
        
        function performOptimizedSearch(searchTerm) {
            if (!treeInstance) return;
            
            try {
                // Disable animations during search for better performance
                const tree = $('#tree');
                const wasAnimated = tree.data('jstree').settings.core.animation;
                tree.jstree('set_animation', 0);
                
                // Perform the search
                treeInstance.search(searchTerm, false, false);
                
                // Restore animations
                tree.jstree('set_animation', wasAnimated);
            } catch (e) {
                console.error('Search error:', e);
            }
        }
        
        // UI Flow Functions
        function showLoginForm() {
            $('#loginForm').removeClass('hidden');
            $('#vinForm').addClass('hidden');
            $('#treeView').addClass('hidden');
            $('#tree').hide();
            $('.controls').hide();
        }
        
        function showVinForm() {
            $('#loginForm').addClass('hidden');
            $('#vinForm').removeClass('hidden');
            $('#treeView').addClass('hidden');
            $('#tree').hide();
            $('#manufacturerSelection').addClass('hidden');
            $('#partsView').addClass('hidden');
            $('.controls').hide();
        }
        
        function showTreeView() {
            console.log('showTreeView called');
            // Hide all other views
            $('#loginForm').addClass('hidden');
            $('#vinForm').addClass('hidden');
            $('#manufacturerSelection').addClass('hidden').css('display', 'none');
            $('#partsView').addClass('hidden');
            
            // Show tree view wrapper and tree - remove hidden class and ensure display
            $('#treeView').removeClass('hidden').css('display', 'block');
            $('#tree').removeClass('hidden').css('display', 'block');
            $('.controls').css('display', 'flex');
            
            // Log for debugging
            console.log('showTreeView - manufacturerSelection hidden:', $('#manufacturerSelection').hasClass('hidden'));
            console.log('showTreeView - treeView visible:', $('#treeView').is(':visible'));
            console.log('showTreeView - tree visible:', $('#tree').is(':visible'));
            console.log('showTreeView - treeInstance exists:', !!treeInstance);
            
            // Restore selected catalog objects in the tree
            if (treeInstance) {
                try {
                    // Deselect all first
                    treeInstance.deselect_all();
                    
                    // Select all previously selected catalog objects
                    if (selectedCatalogObjects.length > 0) {
                        selectedCatalogObjects.forEach((obj) => {
                            const nodeId = 'item_' + obj.catalogObjectID;
                            try {
                                treeInstance.select_node(nodeId);
                            } catch (e) {
                                console.log('Could not select node:', nodeId, e);
                            }
                        });
                        
                        // Update UI
                        $('#selectedCatalogCount').text(`${selectedCatalogObjects.length} catalog object${selectedCatalogObjects.length !== 1 ? 's' : ''} selected`);
                        $('#nextToManufacturersBtn').show();
                        $('#catalogSelectionInfo').show();
                        $('#catalogSelectionInfo').css('background', '#e8f5e9').css('border-left-color', '#4CAF50');
                        $('#selectedCatalogCount').css('color', '#2e7d32');
                    } else if (selectedCatalogObjectID) {
                        // Fallback for backward compatibility
                        const nodeId = 'item_' + selectedCatalogObjectID;
                        try {
                            treeInstance.select_node(nodeId);
                        } catch (e) {
                            console.log('Could not select node:', e);
                        }
                    }
                } catch (e) {
                    console.log('Error restoring tree selection:', e);
                }
            }
        }
        
        function showManufacturerSelection() {
            console.log('showManufacturerSelection called');
            $('#loginForm').addClass('hidden');
            $('#vinForm').addClass('hidden');
            $('#treeView').addClass('hidden').css('display', 'none');
            $('#tree').addClass('hidden').css('display', 'none');
            $('.controls').css('display', 'none');
            $('#manufacturerSelection').removeClass('hidden').css('display', 'block');
            $('#partsView').addClass('hidden');
            // Preserve manufacturer selection state when navigating back
            if (manufacturers.length > 0) {
                $('#manufacturerLoading').hide();
                $('#manufacturerContent').show();
                renderManufacturers();
                updateSelectedCount();
                // Update breadcrumb with catalog object name
                if (selectedCatalogObjectName) {
                    $('#breadcrumbCatalogName').text(selectedCatalogObjectName);
                    $('#manufacturerSubtitle').text(`Select manufacturers and brands for: ${selectedCatalogObjectName}`);
                }
            }
        }
        
        function showPartsView() {
            $('#loginForm').addClass('hidden');
            $('#vinForm').addClass('hidden');
            $('#treeView').addClass('hidden');
            $('#tree').hide();
            $('.controls').hide();
            $('#manufacturerSelection').addClass('hidden');
            $('#partsView').removeClass('hidden').css('display', 'block');
            // Preserve parts data when navigating back
            if (parts.length > 0) {
                $('#partsLoading').hide();
                $('#partsContent').show();
                renderParts();
                // Update breadcrumb with catalog and manufacturer info
                if (selectedCatalogObjectName) {
                    $('#breadcrumbPartsName').text(`${selectedCatalogObjectName} - Parts`);
                    $('#partsSubtitle').text(`Showing ${parts.length} parts for selected manufacturers`);
                }
            } else {
                // Even if no parts yet, ensure partsContent is ready to be shown
                // It will be shown after parts are loaded
            }
        }
        
        function hideManufacturerSelection() {
            $('#manufacturerSelection').addClass('hidden');
        }
        
        // Login Function
        async function loginUser(username, password) {
            try {
                showStatus('üîÑ Logging in...', 'warning');
                $('#loginBtn').prop('disabled', true).text('Logging in...');
                
                const response = await fetch(`${API_BASE_URL}/api/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json',
                        'x-application-key': '',
                    },
                    body: JSON.stringify({
                        username: username,
                        password: password,
                        invalidateOldestToken: true,
                        epnSellerID: ''
                    })
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Login failed: ${response.status} ${response.statusText}. ${errorText}`);
                }
                
                const loginResponse = await response.json();
                accessToken = loginResponse.accessToken;
                
                showStatus('‚úì Login successful!', 'success');
                $('#loginBtn').prop('disabled', false).text('Login');
                
                // Show VIN form after successful login
                setTimeout(() => {
                    showVinForm();
                }, 1000);
                
            } catch (error) {
                console.error('Login error:', error);
                $('#loginBtn').prop('disabled', false).text('Login');
                showStatus('‚úó Login failed: ' + (error.message || 'Please check your credentials and try again.'), 'error');
            }
        }
        
        // VIN Decode Function
        async function decodeVin(vin) {
            if (!accessToken) {
                showStatus('‚úó Please login first', 'error');
                return;
            }
            
            try {
                showStatus('üîÑ Decoding VIN...', 'warning');
                $('#decodeVinBtn').prop('disabled', true).text('Decoding...');
                
                const response = await fetch(`${API_BASE_URL}/api/vin/decode-vin`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                        'Authorization': `Bearer ${accessToken}`
                    },
                    body: JSON.stringify({
                        vins: [vin]
                    })
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`VIN decode failed: ${response.status} ${response.statusText}. ${errorText}`);
                }
                
                const decodeResponse = await response.json();
                
                // Extract vehicle configuration from the first data item
                if (decodeResponse.data && decodeResponse.data.length > 0) {
                    vehicleConfig = decodeResponse.data[0].vehicleConfiguration;
                    
                    if (!vehicleConfig) {
                        throw new Error('Vehicle configuration not found in VIN decode response');
                    }
                    
                    // Store full response for progress summary and download
                    vinDecodeResponse = decodeResponse;
                    apiResponses.vinDecode = decodeResponse;
                    
                    // Update progress summary
                    updateProgressSummary();
                    
                    showStatus('‚úì VIN decoded successfully!', 'success');
                    $('#decodeVinBtn').prop('disabled', false).text('Decode VIN');
                    
                    // Automatically fetch category tree after VIN decode
                    setTimeout(() => {
                        fetchCategoryTree();
                    }, 1000);
                } else {
                    throw new Error('No vehicle data returned from VIN decode');
                }
                
            } catch (error) {
                console.error('VIN decode error:', error);
                $('#decodeVinBtn').prop('disabled', false).text('Decode VIN');
                showStatus('‚úó VIN decode failed: ' + (error.message || 'Please check the VIN and try again.'), 'error');
            }
        }
        
        // Fetch Category Tree from API
        async function fetchCategoryTree() {
            if (!accessToken || !vehicleConfig) {
                showStatus('‚úó Please login and decode VIN first', 'error');
                return;
            }
            
            try {
                showStatus('üîÑ Loading category tree...', 'warning');
                
                const response = await fetch(`${API_BASE_URL}/api/parts/category-tree`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                        'Authorization': `Bearer ${accessToken}`,
                        'X-Vehicle-Configuration': vehicleConfig
                    }
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Category tree fetch failed: ${response.status} ${response.statusText}. ${errorText}`);
                }
                
                const categoryTree = await response.json();
                catalogData = categoryTree;
                
                // Store category tree response for progress summary and download
                apiResponses.categoryTree = categoryTree;
                
                // Build the tree first, then show tree view
                buildTree(categoryTree);
                updateProgressSummary();
                showTreeView();
                
            } catch (error) {
                console.error('Category tree error:', error);
                showStatus('‚úó Failed to load category tree: ' + (error.message || 'Please try again.'), 'error');
            }
        }
        
        // Legacy function - kept for backward compatibility but not used
        async function loadJSON() {
            try {
                const response = await fetch('Full-Categories.json');
                const data = await response.json();
                catalogData = data;
                buildTree(data);
            } catch (error) {
                showStatus('‚ö†Ô∏è Cannot load JSON file automatically. Please select the Full-Categories.json file:', 'warning');
                
                const fileUpload = $('<div class="file-upload">')
                    .append('<p>Select the Full-Categories.json file:</p>')
                    .append('<input type="file" id="fileInput" accept=".json" />')
                    .insertAfter('#statusMessage');
                
                $('#fileInput').on('change', function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        const startTime = Date.now();
                        const fileSizeMB = (file.size / (1024 * 1024)).toFixed(2);
                        
                        // Show loader
                        const loader = $(`
                            <div class="upload-loader show">
                                <div class="loader-content">
                                    <div class="upload-spinner"></div>
                                    <div class="upload-info">
                                        <div>Uploading: <strong>${file.name}</strong></div>
                                        <div style="font-size: 12px; opacity: 0.9;">Size: ${fileSizeMB} MB</div>
                                        <div class="upload-duration">Elapsed: <span id="elapsed">0</span>s</div>
                                    </div>
                                </div>
                            </div>
                        `);
                        fileUpload.after(loader);
                        
                        // Update elapsed time
                        const elapsedInterval = setInterval(() => {
                            const elapsed = ((Date.now() - startTime) / 1000).toFixed(1);
                            $('#elapsed').text(elapsed);
                        }, 100);
                        
                        const reader = new FileReader();
                        reader.onload = function(event) {
                            clearInterval(elapsedInterval);
                            const duration = ((Date.now() - startTime) / 1000).toFixed(2);
                            
                            try {
                                catalogData = JSON.parse(event.target.result);
                                
                                // Show success loader
                                loader.html(`
                                    <div class="loader-content">
                                        <div style="font-size: 30px;">‚úì</div>
                                        <div class="upload-info">
                                            <div><strong>File loaded successfully!</strong></div>
                                            <div style="font-size: 12px; opacity: 0.95; margin-top: 5px;">Total time: ${duration}s</div>
                                        </div>
                                    </div>
                                `).addClass('upload-success').removeClass('show').addClass('show');
                                
                                setTimeout(() => {
                                    loader.remove();
                                    fileUpload.remove();
                                    showStatus('‚úì File loaded successfully in ' + duration + 's!', 'success');
                                    buildTree(catalogData);
                                }, 1500);
                            } catch (error) {
                                // Show error loader
                                loader.html(`
                                    <div class="loader-content">
                                        <div style="font-size: 30px;">‚úó</div>
                                        <div class="upload-info">
                                            <div><strong>Error parsing file</strong></div>
                                            <div style="font-size: 12px; opacity: 0.95; margin-top: 5px;">${error.message}</div>
                                        </div>
                                    </div>
                                `).addClass('upload-error').removeClass('show').addClass('show');
                                
                                setTimeout(() => {
                                    loader.remove();
                                    showStatus('‚úó Error parsing JSON file: ' + error.message, 'error');
                                }, 2000);
                            }
                        };
                        reader.readAsText(file);
                    }
                });
            }
        }
        
        function buildTree(data) {
            const treeData = [];
            
            // Sort categories by ID
            const sortedCategories = data.data.sort((a, b) => a.categoryID - b.categoryID);
            
            // Convert catalog data to jsTree format
            sortedCategories.forEach((category) => {
                const categoryNode = {
                    id: 'cat_' + category.categoryID,
                    text: `<span class="tree-category">${category.categoryID}: ${escapeHtml(category.categoryName)} (${category.groups.length})</span>`,
                    children: [],
                    state: { opened: false }
                };
                
                // Sort groups by ID
                const sortedGroups = category.groups.sort((a, b) => a.groupID - b.groupID);
                
                sortedGroups.forEach((group) => {
                    const groupNode = {
                        id: 'grp_' + group.groupID,
                        text: `<span class="tree-group">${group.groupID}: ${escapeHtml(group.groupName)} (${group.catalogObjects.length})</span>`,
                        children: [],
                        state: { opened: false }
                    };
                    
                    // Sort catalog objects by ID
                    const sortedObjects = group.catalogObjects.sort((a, b) => a.catalogObjectID - b.catalogObjectID);
                    
                    sortedObjects.forEach((item) => {
                        const itemNode = {
                            id: 'item_' + item.catalogObjectID,
                            text: `<span class="tree-item">${item.catalogObjectID}: ${escapeHtml(item.catalogObjectName)}</span>`,
                            icon: 'jstree-file',
                            state: { selected: false }
                        };
                        groupNode.children.push(itemNode);
                    });
                    
                    categoryNode.children.push(groupNode);
                });
                
                treeData.push(categoryNode);
            });
            
            // Initialize jsTree with optimized settings
            $('#tree').jstree('destroy').jstree({
                'core': {
                    'data': treeData,
                    'themes': {
                        'name': 'default',
                        'responsive': true,
                        'stripes': false,
                        'dots': true
                    },
                    'animation': 200,
                    'multiple': true,
                    'check_callback': true
                },
                'search': {
                    'case_insensitive': true,
                    'show_only_matches': true,
                    'show_only_matches_children': true,
                    'fuzzy': false
                },
                'plugins': ['search']
            });
            
            treeInstance = $('#tree').jstree(true);
            
            // Add event handlers for expand/collapse optimization
            $('#tree').on('before_open.jstree before_close.jstree', function(e, data) {
                if (searchActive) {
                    // Ensure animations are disabled during search
                    $('#tree').jstree('set_animation', 0);
                }
            }).on('after_open.jstree after_close.jstree', function(e, data) {
                if (searchActive) {
                    // Keep animations disabled while search is active
                    $('#tree').jstree('set_animation', 0);
                } else {
                    // Re-enable animations when not searching
                    $('#tree').jstree('set_animation', 200);
                }
            });
            
            // Add handlers for multiple catalog object selection (Ctrl/Cmd + Click)
            $('#tree').on('select_node.jstree deselect_node.jstree', function(e, data) {
                updateSelectedCatalogObjects();
            });
            
            // Function to update selected catalog objects and groups
            function updateSelectedCatalogObjects() {
                const selectedNodes = treeInstance.get_selected(true);
                selectedCatalogObjects = [];
                selectedGroups = [];
                
                selectedNodes.forEach((node) => {
                    const nodeId = node.id;
                    
                    // Handle group nodes (grp_*)
                    if (nodeId.startsWith('grp_')) {
                        const groupID = parseInt(nodeId.replace('grp_', ''));
                        
                        // Extract group name from the node text
                        const nodeText = $(node.text).text() || node.text;
                        const match = nodeText.match(/:\s*(.+?)\s*\(/);
                        const groupName = match ? match[1].trim() : `Group ${groupID}`;
                        
                        // Find category for this group
                        let categoryInfo = null;
                        if (catalogData && catalogData.data) {
                            catalogData.data.forEach((category) => {
                                category.groups.forEach((group) => {
                                    if (group.groupID === groupID) {
                                        categoryInfo = {
                                            categoryID: category.categoryID,
                                            categoryName: category.categoryName
                                        };
                                    }
                                });
                            });
                        }
                        
                        selectedGroups.push({
                            groupID: groupID,
                            groupName: groupName,
                            categoryID: categoryInfo ? categoryInfo.categoryID : null,
                            categoryName: categoryInfo ? categoryInfo.categoryName : null
                        });
                    }
                    // Handle catalog object nodes (item_)
                    else if (nodeId.startsWith('item_')) {
                        const catalogObjectID = parseInt(nodeId.replace('item_', ''));
                        
                        // Extract catalog object name from the node text
                        const nodeText = $(node.text).text() || node.text;
                        const match = nodeText.match(/:\s*(.+)$/);
                        const catalogObjectName = match ? match[1].trim() : `Catalog Object ${catalogObjectID}`;
                        
                        // Extract category and group information from tree structure
                        let categoryInfo = null;
                        let groupInfo = null;
                        
                        if (catalogData && catalogData.data) {
                            catalogData.data.forEach((category) => {
                                category.groups.forEach((group) => {
                                    group.catalogObjects.forEach((item) => {
                                        if (item.catalogObjectID === catalogObjectID) {
                                            categoryInfo = {
                                                categoryID: category.categoryID,
                                                categoryName: category.categoryName
                                            };
                                            groupInfo = {
                                                groupID: group.groupID,
                                                groupName: group.groupName
                                            };
                                        }
                                    });
                                });
                            });
                        }
                        
                        selectedCatalogObjects.push({
                            catalogObjectID: catalogObjectID,
                            catalogObjectName: catalogObjectName,
                            category: categoryInfo,
                            group: groupInfo
                        });
                    }
                });
                
                // Update UI with combined counts
                const objectCount = selectedCatalogObjects.length;
                const groupCount = selectedGroups.length;
                const totalCount = objectCount + groupCount;
                
                let countText = '';
                if (totalCount > 0) {
                    if (objectCount > 0 && groupCount > 0) {
                        countText = `${objectCount} object${objectCount !== 1 ? 's' : ''} + ${groupCount} group${groupCount !== 1 ? 's' : ''} selected`;
                    } else if (objectCount > 0) {
                        countText = `${objectCount} catalog object${objectCount !== 1 ? 's' : ''} selected`;
                    } else {
                        countText = `${groupCount} group${groupCount !== 1 ? 's' : ''} selected`;
                    }
                } else {
                    countText = '0 items selected';
                }
                
                $('#selectedCatalogCount').text(countText);
                
                if (totalCount > 0) {
                    $('#nextToManufacturersBtn').show();
                    $('#catalogSelectionInfo').show();
                    $('#catalogSelectionInfo').css('background', '#e8f5e9').css('border-left-color', '#4CAF50');
                    $('#selectedCatalogCount').css('color', '#2e7d32');
                } else {
                    $('#nextToManufacturersBtn').hide();
                    $('#catalogSelectionInfo').show();
                    $('#catalogSelectionInfo').css('background', '#fff3cd').css('border-left-color', '#ffc107');
                    $('#selectedCatalogCount').css('color', '#856404');
                }
                
                // Update progress summary
                updateProgressSummary();
                
                // For backward compatibility, set the first selected as primary
                if (selectedCatalogObjects.length > 0) {
                    selectedCatalogObjectID = selectedCatalogObjects[0].catalogObjectID;
                    selectedCatalogObjectName = selectedCatalogObjects[0].catalogObjectName;
                    if (selectedCatalogObjects[0].category) {
                        selectedCategory = selectedCatalogObjects[0].category;
                    }
                    if (selectedCatalogObjects[0].group) {
                        selectedGroup = selectedCatalogObjects[0].group;
                    }
                } else if (selectedGroups.length > 0) {
                    // Use first group's category if no catalog objects selected
                    if (selectedGroups[0].categoryID) {
                        selectedCategory = {
                            categoryID: selectedGroups[0].categoryID,
                            categoryName: selectedGroups[0].categoryName
                        };
                    }
                    selectedGroup = {
                        groupID: selectedGroups[0].groupID,
                        groupName: selectedGroups[0].groupName
                    };
                } else {
                    selectedCatalogObjectID = null;
                    selectedCatalogObjectName = null;
                    selectedCategory = null;
                    selectedGroup = null;
                }
            }
            
            showStatus('‚úì Catalog loaded successfully! (Total: ' + treeData.length + ' categories)', 'success');
        }
        
        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }
        
        function showStatus(message, type) {
            const statusEl = $('#statusMessage');
            statusEl.text(message).addClass('show');
            
            if (type === 'success') {
                statusEl.css('background', '#d4edda').css('border-color', '#28a745').css('color', '#155724');
            } else if (type === 'warning') {
                statusEl.css('background', '#fff3cd').css('border-color', '#ffc107').css('color', '#856404');
            } else if (type === 'error') {
                statusEl.css('background', '#f8d7da').css('border-color', '#f5c6cb').css('color', '#721c24');
            }
            
            if (type === 'success') {
                setTimeout(() => statusEl.removeClass('show'), 3000);
            }
        }
        
        // Fetch Manufacturers Function
        async function fetchManufacturers(catalogObjectIDs, catalogGroupIDs) {
            if (!accessToken || !vehicleConfig) {
                showStatus('‚úó Please login and decode VIN first', 'error');
                return;
            }
            
            // Handle both single ID (backward compatibility) and array of IDs
            const objIds = Array.isArray(catalogObjectIDs) ? catalogObjectIDs : (catalogObjectIDs ? [catalogObjectIDs] : []);
            const grpIds = Array.isArray(catalogGroupIDs) ? catalogGroupIDs : (catalogGroupIDs ? [catalogGroupIDs] : []);
            
            if (objIds.length === 0 && grpIds.length === 0) {
                showStatus('‚ö†Ô∏è Please select at least one catalog object or group', 'warning');
                return;
            }
            
            try {
                showManufacturerSelection();
                $('#manufacturerLoading').show();
                $('#manufacturerContent').hide();
                
                // Build URL with both catalog object IDs and group IDs
                let url = `${API_BASE_URL}/api/parts/manufacturers?regionIDs=1&allManufacturers=true&includeOem=true`;
                
                if (objIds.length > 0) {
                    url += `&catalogObjectIDs=${objIds.join(',')}`;
                }
                if (grpIds.length > 0) {
                    url += `&catalogGroupIDs=${grpIds.join(',')}`;
                }
                
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Accept-Language': 'en-US',
                        'X-Vehicle-Configuration': vehicleConfig
                    }
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Manufacturers fetch failed: ${response.status} ${response.statusText}. ${errorText}`);
                }
                
                const manufacturersResponse = await response.json();
                manufacturers = manufacturersResponse.data;
                
                // Store manufacturers response for progress summary and download
                apiResponses.manufacturers = manufacturersResponse;
                
                // Build all brands list and select all by default
                allBrands = [];
                selectedBrands.clear();
                
                manufacturers.forEach((manufacturer) => {
                    manufacturer.brands.forEach((brand) => {
                        allBrands.push({
                            manufacturerID: manufacturer.manufacturerID,
                            manufacturerName: manufacturer.manufacturerName,
                            brandID: brand.brandID,
                            brandName: brand.brandName
                        });
                        // Select all brands by default
                        selectedBrands.add(brand.brandID);
                    });
                });
                
                renderManufacturers();
                updateSelectedCount();
                
                // Update breadcrumb with catalog object name
                if (selectedCatalogObjectName) {
                    $('#breadcrumbCatalogName').text(selectedCatalogObjectName);
                    $('#manufacturerSubtitle').text(`Select manufacturers and brands for: ${selectedCatalogObjectName}`);
                }
                
                // Update progress summary
                updateProgressSummary();
                
                $('#manufacturerLoading').hide();
                $('#manufacturerContent').show();
                showStatus('‚úì Manufacturers loaded successfully!', 'success');
                
                // Auto-advance to parts screen if coming from catalog tree
                if (autoAdvanceToPartsScreen) {
                    autoAdvanceToPartsScreen = false;
                    // Automatically proceed to parts screen after a short delay
                    setTimeout(() => {
                        fetchParts();
                    }, 500);
                }
                
            } catch (error) {
                console.error('Manufacturers error:', error);
                $('#manufacturerLoading').hide();
                showStatus('‚úó Failed to load manufacturers: ' + (error.message || 'Please try again.'), 'error');
            }
        }
        
        // Render Manufacturers Function
        function renderManufacturers(filteredBrands) {
            const manufacturerList = $('#manufacturerList');
            const brandsToRender = filteredBrands || allBrands;
            
            // Group by manufacturer
            const manufacturerMap = new Map();
            
            brandsToRender.forEach((brand) => {
                if (!manufacturerMap.has(brand.manufacturerID)) {
                    const manufacturer = manufacturers.find((m) => m.manufacturerID === brand.manufacturerID);
                    if (manufacturer) {
                        manufacturerMap.set(brand.manufacturerID, {
                            manufacturer: manufacturer,
                            brands: []
                        });
                    }
                }
                const entry = manufacturerMap.get(brand.manufacturerID);
                if (entry) {
                    entry.brands.push(brand);
                }
            });
            
            let html = '';
            manufacturerMap.forEach(({ manufacturer, brands }) => {
                const manufacturerKey = `mfr-${manufacturer.manufacturerID}`;
                const selectedCount = brands.filter(b => selectedBrands.has(b.brandID)).length;
                const totalCount = brands.length;
                const isAllSelected = selectedCount === totalCount;
                const isExpanded = !filteredBrands; // Expanded by default when not filtering
                
                html += `
                    <div class="manufacturer-tree-item">
                        <div class="manufacturer-header" data-manufacturer-id="${manufacturer.manufacturerID}">
                            <button class="tree-toggle" data-target="${manufacturerKey}" aria-expanded="${isExpanded}">
                                <span class="tree-icon">${isExpanded ? '‚ñº' : '‚ñ∂'}</span>
                            </button>
                            <label class="manufacturer-checkbox-label">
                                <input 
                                    type="checkbox" 
                                    class="manufacturer-checkbox"
                                    data-manufacturer-id="${manufacturer.manufacturerID}"
                                    ${isAllSelected ? 'checked' : ''}
                                />
                                <span class="manufacturer-name">${escapeHtml(manufacturer.manufacturerName)}</span>
                            </label>
                            <span class="brand-count">${selectedCount}/${totalCount} brands</span>
                        </div>
                        <div class="brands-container ${isExpanded ? 'expanded' : ''}" id="${manufacturerKey}">
                            <div class="brands-list">
                                ${brands.map((brand) => `
                                    <div class="brand-item">
                                        <label>
                                            <input 
                                                type="checkbox" 
                                                class="brand-checkbox"
                                                data-brand-id="${brand.brandID}"
                                                data-manufacturer-id="${brand.manufacturerID}"
                                                ${selectedBrands.has(brand.brandID) ? 'checked' : ''}
                                            />
                                            <span class="brand-name">${escapeHtml(brand.brandName)}</span>
                                        </label>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            manufacturerList.html(html);
            
            // Attach event handlers
            $('.tree-toggle').click(function() {
                const target = $(this).data('target');
                const container = $('#' + target);
                const isExpanded = container.hasClass('expanded');
                
                container.toggleClass('expanded');
                $(this).find('.tree-icon').text(isExpanded ? '‚ñ∂' : '‚ñº');
                $(this).attr('aria-expanded', !isExpanded);
            });
            
            $('.manufacturer-checkbox').change(function() {
                const manufacturerID = $(this).data('manufacturer-id');
                const isChecked = $(this).is(':checked');
                const brandCheckboxes = $(`.brand-checkbox[data-manufacturer-id="${manufacturerID}"]`);
                
                brandCheckboxes.each(function() {
                    const brandID = $(this).data('brand-id');
                    $(this).prop('checked', isChecked);
                    if (isChecked) {
                        selectedBrands.add(brandID);
                    } else {
                        selectedBrands.delete(brandID);
                    }
                });
                
                updateSelectedCount();
                updateManufacturerCheckbox(manufacturerID);
            });
            
            $('.brand-checkbox').change(function() {
                const brandID = $(this).data('brand-id');
                const manufacturerID = $(this).data('manufacturer-id');
                const isChecked = $(this).is(':checked');
                
                if (isChecked) {
                    selectedBrands.add(brandID);
                } else {
                    selectedBrands.delete(brandID);
                }
                
                updateSelectedCount();
                updateManufacturerCheckbox(manufacturerID);
            });
        }
        
        // Update Manufacturer Checkbox State
        function updateManufacturerCheckbox(manufacturerID) {
            const brandCheckboxes = $(`.brand-checkbox[data-manufacturer-id="${manufacturerID}"]`);
            const selectedCount = brandCheckboxes.filter(':checked').length;
            const totalCount = brandCheckboxes.length;
            const manufacturerCheckbox = $(`.manufacturer-checkbox[data-manufacturer-id="${manufacturerID}"]`);
            
            manufacturerCheckbox.prop('checked', selectedCount === totalCount);
            manufacturerCheckbox.closest('.manufacturer-header').find('.brand-count').text(`${selectedCount}/${totalCount} brands`);
        }
        
        // Update Selected Count
        function updateSelectedCount() {
            $('#selectedCount').text(`${selectedBrands.size} brand${selectedBrands.size !== 1 ? 's' : ''} selected`);
            // Update progress summary when brand selection changes
            updateProgressSummary();
        }
        
        // Select All Brands
        function selectAllBrands() {
            allBrands.forEach((brand) => {
                selectedBrands.add(brand.brandID);
            });
            $('.brand-checkbox').prop('checked', true);
            $('.manufacturer-checkbox').prop('checked', true);
            updateSelectedCount();
            allBrands.forEach((brand) => {
                updateManufacturerCheckbox(brand.manufacturerID);
            });
        }
        
        // Deselect All Brands
        function deselectAllBrands() {
            selectedBrands.clear();
            $('.brand-checkbox').prop('checked', false);
            $('.manufacturer-checkbox').prop('checked', false);
            updateSelectedCount();
            allBrands.forEach((brand) => {
                updateManufacturerCheckbox(brand.manufacturerID);
            });
        }
        
        // Filter Manufacturers
        function filterManufacturers(searchTerm) {
            if (!searchTerm) {
                renderManufacturers();
                return;
            }
            
            const filtered = allBrands.filter((brand) => {
                const manufacturer = manufacturers.find((m) => m.manufacturerID === brand.manufacturerID);
                return (
                    brand.brandName.toLowerCase().includes(searchTerm) ||
                    (manufacturer && manufacturer.manufacturerName.toLowerCase().includes(searchTerm))
                );
            });
            
            renderManufacturers(filtered);
        }
        
        // Fetch Parts Function
        async function fetchParts() {
            if (!accessToken || !vehicleConfig) {
                showStatus('‚úó Missing required information', 'error');
                return;
            }
            
            // Use selectedCatalogObjects and selectedGroups arrays
            const catalogObjectIDs = selectedCatalogObjects.length > 0 
                ? selectedCatalogObjects.map(obj => obj.catalogObjectID)
                : (selectedCatalogObjectID ? [selectedCatalogObjectID] : []);
            const catalogGroupIDs = selectedGroups.length > 0 
                ? selectedGroups.map(grp => grp.groupID)
                : [];
            
            if (catalogObjectIDs.length === 0 && catalogGroupIDs.length === 0) {
                showStatus('‚úó Please select at least one catalog object or group', 'error');
                return;
            }
            
            if (selectedBrands.size === 0) {
                showStatus('‚ö†Ô∏è Please select at least one brand', 'warning');
                return;
            }
            
            try {
                showPartsView();
                $('#partsLoading').show();
                $('#partsContent').hide();
                
                // Build CCL object from selected manufacturers/brands
                const cclDetails = [];
                const selectedBrandsArray = Array.from(selectedBrands);
                
                allBrands.forEach((brand) => {
                    if (selectedBrandsArray.includes(brand.brandID)) {
                        cclDetails.push({
                            manufacturerID: parseInt(brand.manufacturerID, 10),
                            manufacturerBrandID: brand.brandID
                        });
                    }
                });
                
                const ccl = {
                    cclID: 1,
                    name: 'virtual CCL',
                    cclDetails: cclDetails
                };
                
                // Build URL with both catalog object IDs and group IDs
                let url = `${API_BASE_URL}/api/parts/get-part-fitments?regionID=1`;
                
                if (catalogObjectIDs.length > 0) {
                    url += `&catalogObjectIDs=${catalogObjectIDs.join(',')}`;
                }
                if (catalogGroupIDs.length > 0) {
                    url += `&catalogGroupIDs=${catalogGroupIDs.join(',')}`;
                }
                
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'X-Vehicle-Configuration': vehicleConfig,
                        'Content-Type': 'application/json',
                        'Accept-Language': 'en-US',
                        'X-CCL': JSON.stringify(ccl)
                    }
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Parts fetch failed: ${response.status} ${response.statusText}. ${errorText}`);
                }
                
                const partsResponse = await response.json();
                
                console.log('Parts API response:', partsResponse);
                
                // Handle different response structures
                if (partsResponse.data && Array.isArray(partsResponse.data)) {
                    parts = partsResponse.data;
                } else if (Array.isArray(partsResponse)) {
                    parts = partsResponse;
                } else {
                    parts = [];
                    console.warn('Unexpected parts response structure:', partsResponse);
                }
                
                console.log('Parts array after processing:', parts);
                console.log('Parts count:', parts.length);
                
                // Store parts response for progress summary and download
                apiResponses.parts = partsResponse;
                
                // Render parts immediately
                renderParts();
                
                // Update breadcrumb with catalog and manufacturer info
                if (selectedCatalogObjectName) {
                    $('#breadcrumbPartsName').text(`${selectedCatalogObjectName} - Parts`);
                    $('#partsSubtitle').text(`Showing ${parts.length} parts for selected manufacturers`);
                }
                
                // Update progress summary
                updateProgressSummary();
                
                $('#partsLoading').hide();
                $('#partsContent').show();
                showStatus(`‚úì Loaded ${parts.length} parts successfully!`, 'success');
                
            } catch (error) {
                console.error('Parts error:', error);
                $('#partsLoading').hide();
                showStatus('‚úó Failed to load parts: ' + (error.message || 'Please try again.'), 'error');
            }
        }
        
        // Render Parts Function
        function renderParts() {
            const partsList = $('#partsList');
            
            console.log('=== RENDERING PARTS ===');
            console.log('Parts variable:', parts);
            console.log('Parts type:', typeof parts);
            console.log('Is array:', Array.isArray(parts));
            console.log('Parts length:', parts ? parts.length : 'null/undefined');
            
            if (!parts) {
                console.error('Parts is null or undefined!');
                partsList.html('<p style="text-align: center; padding: 20px; color: #dc3545;">Error: Parts data is not available. Check console for details.</p>');
                return;
            }
            
            if (!Array.isArray(parts)) {
                console.error('Parts is not an array! Type:', typeof parts, 'Value:', parts);
                partsList.html('<p style="text-align: center; padding: 20px; color: #dc3545;">Error: Parts data is not in the expected format. Check console for details.</p>');
                return;
            }
            
            if (parts.length === 0) {
                console.log('Parts array is empty');
                partsList.html('<p style="text-align: center; padding: 20px; color: #6c757d;">No parts found for the selected manufacturers.</p>');
                return;
            }
            
            console.log('Rendering', parts.length, 'parts');
            
            let html = `
                <table class="parts-table">
                    <thead>
                        <tr>
                            <th>Image</th>
                            <th>Part Number</th>
                            <th>Part Name</th>
                            <th>Manufacturer</th>
                            <th>Brand</th>
                            <th>Year Range</th>
                            <th>Qty</th>
                            <th>Condition</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            parts.forEach((part, index) => {
                try {
                    const imageUrl = part.partContents && Array.isArray(part.partContents) && part.partContents.length > 0 ? part.partContents[0].url : '';
                    const imageHtml = imageUrl ? `<img src="${escapeHtml(imageUrl)}" alt="Part image" class="part-image" onerror="this.style.display='none'" />` : '-';
                    
                    // Safely access nested properties with fallbacks
                    const partNumber = part.partNumber || part.partnumber || '-';
                    const partName = part.catalogObject?.catalogObjectName || part.catalogObjectName || part.name || '-';
                    const manufacturerName = part.manufacturer?.name || part.manufacturerName || '-';
                    const brandName = part.manufacturer?.brand?.name || part.brandName || part.brand?.name || '-';
                    const fromYear = part.fromYear || part.fromyear || '';
                    const toYear = part.toYear || part.toyear || '';
                    const yearRange = fromYear ? `${fromYear} - ${toYear}` : '-';
                    const qty = part.qty || part.quantity || part.qtyRequired || '-';
                    const condition = part.condition || part.partCondition || '-';
                    
                    html += `
                        <tr>
                            <td>${imageHtml}</td>
                            <td><span class="part-number">${escapeHtml(String(partNumber))}</span></td>
                            <td>${escapeHtml(String(partName))}</td>
                            <td><span class="part-manufacturer">${escapeHtml(String(manufacturerName))}</span></td>
                            <td>${escapeHtml(String(brandName))}</td>
                            <td>${escapeHtml(yearRange)}</td>
                            <td>${escapeHtml(String(qty))}</td>
                            <td>${escapeHtml(String(condition))}</td>
                        </tr>
                    `;
                } catch (error) {
                    console.error('Error rendering part at index', index, ':', error, part);
                    // Render a row with error info for debugging
                    html += `
                        <tr style="background: #fff3cd;">
                            <td colspan="8" style="color: #856404; padding: 10px;">
                                Error rendering part (check console for details). Part keys: ${Object.keys(part || {}).join(', ')}
                            </td>
                        </tr>
                    `;
                }
            });
            
            html += `
                    </tbody>
                </table>
            `;
            
            partsList.html(html);
        }
        
        // Update Progress Summary Function
        function updateProgressSummary() {
            // Show progress summary if any data is available
            const hasAnyData = vinDecodeResponse || selectedCatalogObjects.length > 0 || selectedCategory || apiResponses.manufacturers || apiResponses.parts;
            
            if (hasAnyData) {
                $('#progressSummary').removeClass('hidden');
            } else {
                $('#progressSummary').addClass('hidden');
                return;
            }
            
            // Update Vehicle Information Section
            if (vinDecodeResponse && vinDecodeResponse.data && vinDecodeResponse.data.length > 0) {
                const vehicleData = vinDecodeResponse.data[0];
                let vehicleHtml = '';
                
                // Display only meaningful vehicle fields in a clean format
                const vehicleFields = [
                    { key: 'year', label: 'Year' },
                    { key: 'make', label: 'Make' },
                    { key: 'model', label: 'Model' },
                    { key: 'trim', label: 'Trim' },
                    { key: 'bodyType', label: 'Body Type' },
                    { key: 'bodyStyle', label: 'Body Style' },
                    { key: 'engine', label: 'Engine' },
                    { key: 'engineSize', label: 'Engine Size' },
                    { key: 'engineType', label: 'Engine Type' },
                    { key: 'transmission', label: 'Transmission' },
                    { key: 'driveType', label: 'Drive Type' },
                    { key: 'fuelType', label: 'Fuel Type' }
                ];
                
                vehicleFields.forEach((field) => {
                    const value = vehicleData[field.key];
                    if (value !== null && value !== undefined && value !== '') {
                        // Handle nested objects (like engine)
                        let displayValue = value;
                        if (typeof value === 'object') {
                            if (value.name) {
                                displayValue = value.name;
                            } else if (value.description) {
                                displayValue = value.description;
                            } else {
                                displayValue = Object.values(value).filter(v => v).join(', ');
                            }
                        }
                        vehicleHtml += `
                            <div class="progress-item">
                                <span class="progress-label">${escapeHtml(field.label)}:</span>
                                <span class="progress-value">${escapeHtml(String(displayValue))}</span>
                            </div>
                        `;
                    }
                });
                
                // Also show VIN if available
                if (vehicleData.vin) {
                    vehicleHtml += `
                        <div class="progress-item">
                            <span class="progress-label">VIN:</span>
                            <span class="progress-value">${escapeHtml(vehicleData.vin)}</span>
                        </div>
                    `;
                }
                
                $('#vehicleInfoContent').html(vehicleHtml);
                $('#vehicleInfoSection').removeClass('hidden');
            } else {
                $('#vehicleInfoSection').addClass('hidden');
            }
            
            // Update Catalog Selection Section
            if (selectedCatalogObjects.length > 0) {
                let catalogHtml = '';
                
                catalogHtml += `
                    <div class="progress-item">
                        <span class="progress-label">Selected:</span>
                        <span class="progress-value">${selectedCatalogObjects.length} catalog object${selectedCatalogObjects.length !== 1 ? 's' : ''}</span>
                    </div>
                `;
                
                // Show catalog objects grouped by category/group
                const groupedByCategory = new Map();
                selectedCatalogObjects.forEach((obj) => {
                    if (obj.category && obj.group) {
                        const key = `${obj.category.categoryID}-${obj.group.groupID}`;
                        if (!groupedByCategory.has(key)) {
                            groupedByCategory.set(key, {
                                category: obj.category,
                                group: obj.group,
                                catalogObjects: []
                            });
                        }
                        groupedByCategory.get(key).catalogObjects.push(obj);
                    }
                });
                
                // Display grouped catalog objects
                groupedByCategory.forEach((groupData) => {
                    catalogHtml += `
                        <div class="progress-item" style="margin-top: 8px; padding-top: 8px; border-top: 1px solid #e9ecef;">
                            <span class="progress-label" style="font-weight: 600; color: #667eea;">${escapeHtml(groupData.category.categoryName)} / ${escapeHtml(groupData.group.groupName)}:</span>
                            <span class="progress-value">${groupData.catalogObjects.length} object${groupData.catalogObjects.length !== 1 ? 's' : ''}</span>
                        </div>
                    `;
                    
                    // Show catalog object names (limit to first 3 per group)
                    const objectNames = groupData.catalogObjects
                        .slice(0, 3)
                        .map(obj => obj.catalogObjectName)
                        .join(', ');
                    const moreText = groupData.catalogObjects.length > 3 
                        ? ` +${groupData.catalogObjects.length - 3} more` 
                        : '';
                    
                    if (objectNames) {
                        catalogHtml += `
                            <div class="progress-item" style="padding-left: 15px; font-size: 12px;">
                                <span class="progress-value">${escapeHtml(objectNames)}${moreText}</span>
                            </div>
                        `;
                    }
                });
                
                $('#catalogSelectionContent').html(catalogHtml);
                $('#catalogSelectionSection').removeClass('hidden');
            } else if (selectedCategory && selectedGroup && selectedCatalogObjectID) {
                // Fallback for backward compatibility
                let catalogHtml = '';
                
                catalogHtml += `
                    <div class="progress-item">
                        <span class="progress-label">Category:</span>
                        <span class="progress-value">${selectedCategory.categoryID} - ${escapeHtml(selectedCategory.categoryName)}</span>
                    </div>
                    <div class="progress-item">
                        <span class="progress-label">Group:</span>
                        <span class="progress-value">${selectedGroup.groupID} - ${escapeHtml(selectedGroup.groupName)}</span>
                    </div>
                    <div class="progress-item">
                        <span class="progress-label">Catalog Object:</span>
                        <span class="progress-value">${selectedCatalogObjectID} - ${escapeHtml(selectedCatalogObjectName || 'N/A')}</span>
                    </div>
                `;
                
                $('#catalogSelectionContent').html(catalogHtml);
                $('#catalogSelectionSection').removeClass('hidden');
            } else {
                $('#catalogSelectionSection').addClass('hidden');
            }
            
            // Update Manufacturer Selection Section
            if (apiResponses.manufacturers && manufacturers.length > 0) {
                const selectedBrandsCount = selectedBrands.size;
                const selectedManufacturers = new Map(); // Map of manufacturerID -> {name, brands: []}
                
                // Group selected brands by manufacturer
                allBrands.forEach((brand) => {
                    if (selectedBrands.has(brand.brandID)) {
                        if (!selectedManufacturers.has(brand.manufacturerID)) {
                            const mfr = manufacturers.find(m => m.manufacturerID === brand.manufacturerID);
                            selectedManufacturers.set(brand.manufacturerID, {
                                name: mfr ? mfr.manufacturerName : 'Unknown',
                                brands: []
                            });
                        }
                        selectedManufacturers.get(brand.manufacturerID).brands.push(brand.brandName);
                    }
                });
                
                let manufacturerHtml = `
                    <div class="progress-item">
                        <span class="progress-label">Selected:</span>
                        <span class="progress-value">${selectedBrandsCount} brand${selectedBrandsCount !== 1 ? 's' : ''} from ${selectedManufacturers.size} manufacturer${selectedManufacturers.size !== 1 ? 's' : ''}</span>
                    </div>
                `;
                
                // Show selected manufacturers with their brands
                selectedManufacturers.forEach((mfrData, mfrID) => {
                    const brandsList = mfrData.brands.length <= 3 
                        ? mfrData.brands.join(', ')
                        : mfrData.brands.slice(0, 3).join(', ') + ` +${mfrData.brands.length - 3} more`;
                    
                    manufacturerHtml += `
                        <div class="progress-item" style="margin-top: 8px; padding-top: 8px; border-top: 1px solid #e9ecef;">
                            <span class="progress-label" style="font-weight: 600; color: #667eea;">${escapeHtml(mfrData.name)}:</span>
                            <span class="progress-value">${escapeHtml(brandsList)}</span>
                        </div>
                    `;
                });
                
                $('#manufacturerSelectionContent').html(manufacturerHtml);
                $('#manufacturerSelectionSection').removeClass('hidden');
            } else {
                $('#manufacturerSelectionSection').addClass('hidden');
            }
            
            // Update Parts Section
            if (apiResponses.parts && parts.length > 0) {
                let partsHtml = `
                    <div class="progress-item">
                        <span class="progress-label">Total Parts:</span>
                        <span class="progress-value">${parts.length}</span>
                    </div>
                `;
                
                $('#partsContent').html(partsHtml);
                $('#partsSection').removeClass('hidden');
            } else {
                $('#partsSection').addClass('hidden');
            }
        }
        
        // Download JSON Helper Function
        function downloadJSON(data, filename) {
            try {
                const jsonString = JSON.stringify(data, null, 2);
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            } catch (error) {
                console.error('Download error:', error);
                showStatus('‚úó Failed to download file: ' + error.message, 'error');
            }
        }
        
        // Download Functions for each response type
        function downloadVinResponse() {
            if (apiResponses.vinDecode) {
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
                downloadJSON(apiResponses.vinDecode, `vin-decode-${timestamp}.json`);
            } else {
                showStatus('‚ö†Ô∏è No VIN decode response available to download', 'warning');
            }
        }
        
        function downloadCategoryTree() {
            if (apiResponses.categoryTree) {
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
                downloadJSON(apiResponses.categoryTree, `category-tree-${timestamp}.json`);
            } else {
                showStatus('‚ö†Ô∏è No category tree available to download', 'warning');
            }
        }
        
        function downloadManufacturers() {
            if (apiResponses.manufacturers) {
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
                downloadJSON(apiResponses.manufacturers, `manufacturers-${timestamp}.json`);
            } else {
                showStatus('‚ö†Ô∏è No manufacturers data available to download', 'warning');
            }
        }
        
        function downloadParts() {
            if (apiResponses.parts) {
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
                downloadJSON(apiResponses.parts, `parts-${timestamp}.json`);
            } else {
                showStatus('‚ö†Ô∏è No parts data available to download', 'warning');
            }
        }
    </script>
</body>
</html>